<template>
    <nav :class="['grad-nav', navShown ? '' : 'grad-nav--hidden', small ? 'grad-nav--small' : '' ]">
        <div class="grad-nav__header" @click="$router.push('/')">
            <img src="@/assets/adlerkopp.svg" alt="adlerkopp" />
            <div v-if="small">
                <span>{{activeLink.text}}</span>
            </div>
        </div>
        <template v-if="small">
            <NavClose v-if="expanded" @click="close" />
            <NavMenu v-else @click="open" />
        </template>
        <template v-if="!small || expanded">
            <div class="grad-nav__links">
                <template v-for="link in links">
                    <div 
                        :key="link.url"
                        class="grad-nav__link-wrapper"
                    >
                        <router-link 
                            class="grad-nav__link"
                            :to="link.url"
                            tag="a"
                        >
                            {{link.text}}
                        </router-link>
                    </div>
                </template>
                <div 
                    class="grad-nav__link-wrapper"
                >
                    <router-link 
                        to="/logout"
                        tag="a"
                        class="grad-nav__link"
                    >
                        <i class="material-icons">logout</i>
                    </router-link>
                </div>
            </div>
        </template>
    </nav>
</template>

<script lang="ts">
import { Component, Vue, Watch, Prop } from 'vue-property-decorator';
import NavMenu from './Navbar/small-menu-btn/Menu.vue';
import NavClose from './Navbar/small-menu-btn/Close.vue';
import { GradLink } from './Navbar/GradLink';
import { Route } from 'vue-router';

const SMALL_BREAKPOINT = 710;

@Component ({
    name: 'navbar',
    components: { NavMenu, NavClose }
})
export default class Navbar extends Vue {
    private links: GradLink[] = require('./Navbar/links.json');

    private activeLink: GradLink = { text: '', url: ''};
    private small: boolean = false;
    private expanded: boolean = false;              // Indicates whether the main nav is shown (only in small)
    private resizeTimeout: number | undefined;
    private pageYOffset: number = 0;                // for hiding nav bar when scrolling
    private navShown: boolean = true;               // for hiding nav bar when scrolling

    private mounted() {
        this.updateActiveLink(this.$route);
        window.addEventListener('resize', this.handleResize);
        window.addEventListener('scroll', this.handleScroll);
    }

    private updated() {
        this.onResizeTimeout();
        this.$nextTick(this.fixSubLinksOffset);
    }

    private beforeDestroy() {
        window.removeEventListener('resize', this.handleResize);
        window.removeEventListener('scroll', this.handleScroll);
    }

    @Watch('$route')
    private routeChanged(to: Route, from: Route) {
        if (to.path === from.path) return;

        this.expanded = false;
        this.updateActiveLink(to);
    }

    /**
     * @description Update active link
     * @author DerZade
     * @param {any} route Route
     */
    private updateActiveLink(route: any) {
        const url = `/${route.path.split('/')[1]}`;
        const suburl = route.path.replace(new RegExp(`^${url}`, 'i'), '');

        this.activeLink = this.links.find(l => l.url === url) || { text: '', url: ''};
    }

    /**
     * @description Click callback of open button in small menu
     * @author DerZade
     */
    private open() {
        this.expanded = true;
    }

    /**
     * @description Click callback of close button in small menu
     * @author DerZade
     */
    private close() {
        this.expanded = false;
    }

    /**
     * @description Window resize handler callback. Calls actual function via a
     *              timeout to prevent a lot of activations in a small amount of time.
     * @author DerZade
     */
    private handleResize() {
        if (this.resizeTimeout !== undefined) clearTimeout(this.resizeTimeout);

        setTimeout(this.onResizeTimeout.bind(this), 100);
    }

    /**
     * @description Actual window resize callback
     * @author DerZade
     */
    private onResizeTimeout() {
        if (window.innerWidth < SMALL_BREAKPOINT) {
            this.small = true;
        } else {
            this.small = false;
        }
    }

    /**
     * @description Window scroll handler callback. Hides navbar when user is scrolled down
     * @author DerZade
     */
    private handleScroll(event: Event) {
        if (this.expanded) return;

        if (pageYOffset > this.pageYOffset) {
            // user scrolled down
            if (pageYOffset > 80) {
                this.navShown = false;
            }
        } else {
            // user scrolled up
            this.navShown = true;
        }
        this.pageYOffset = pageYOffset;
    }

    /**
     * @description Prevents sublinks to clip outside the right window border
     * @author DerZade
     */
    private fixSubLinksOffset() {
        if (this.small) return;

        // find all sub link containers
        const subLinkContainers: NodeListOf<Element> = document.querySelectorAll('.grad-nav__sub-links');

        // get the right edge of the sub-link bar
        const subLinkBar = document.querySelector('.grad-nav__sub-link-bar');
        if (!subLinkBar) return;
        const maxRight = subLinkBar.getBoundingClientRect().right;

        for (const child of subLinkContainers) {
            const elem = child as HTMLElement;
            const right = elem.getBoundingClientRect().right;

            if (right > maxRight) {
                elem.style.left = `${maxRight - right}px`;
            }
        }
    }

}
</script>

<style lang="scss" scoped>
$navbar-height: 72px;

.grad-nav {
    user-select: none;
    height: $navbar-height;
    display: flex;
    justify-content: space-between;
    align-items: center;
    
    font-family: 'Oswald', sans-serif;
    text-transform: uppercase;
    color: white;
    background-color: black;

    position: fixed;
    top: 0px;
    left: 0px;
    right: 0px;
    z-index: 1000;
    transition: top .25s ease-in-out;

    &.grad-nav--hidden {
        top: - $navbar-height;
    }
    
    &__header {
        height: 45px;
        cursor: pointer;
        flex: none;
        display: flex;
        align-items: center;
        margin-left: 21px;

        img {
            margin-right: 8px;
            height: 50px;
        }
        span {
            font-size: 12px;
            display: block;

            &:nth-child(2) {
                opacity: 0.5;
            }

            &:only-child {
                font-size: 27px;
            }
        }
    }

    &__link {
        cursor: pointer;
        display: flex;
        align-items: center;
        flex: none;
        box-sizing: border-box;
        height: 100%;
        margin: 0px 10px;
        opacity: 0.7;

        border-top: 4px solid transparent;
        border-bottom: 4px solid transparent;
        padding: 0px 2px;

        > img {
            height: 1em;
        }

        &:hover {
            opacity: 1;
        }

        &.grad-nav--active { // active link in main links
            opacity: 1;
            border-top-color: #D18D1F;
        }
    }

    &__links {
        display: flex;
        justify-content: flex-end;
        height: 100%;
        font-size: 18px;
    }

    &--small {
        .grad-nav__links {
            position: fixed;
            top: $navbar-height;
            bottom: 0px;
            left: 0px;
            right: 0px;
            background-color: black;

            flex-direction: column;
            justify-content: initial;

        }
        .grad-nav__link {
            border: none;
            margin: 0px 0px;

            height: auto;
            cursor: pointer;
            align-items: center;
            display: flex;
            line-height: 20px;
            font-size: 20px;
            padding: 5px 0 5px 27px;
            border-left: 4px solid transparent;

            &.grad-nav--active { // active link in main links
                opacity: 1;
                border-left-color: #D18D1F;
            }
        }

        .grad-nav__link-wrapper {
            margin: 15px 0 0 0;
        }
    }

    
    @media (max-width: 1000px) {
        .grad-nav--min1000 {
            display: none;
        }
    }

}
</style>
